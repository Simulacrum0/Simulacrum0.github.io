//==============================================
// STARTUP
//==============================================

// ONLY SAVE last 64 log lines
const SmaBraHi_wuk = 64;
const SmaViKa_wuk = ( SmaBraHi_wuk - 1 );

//----------------------------
// SYSTEM SERVICE_GOVERNOR
//----------------------------
var Ko =
{
	//@@@
	// BOOT
	WASM64_yk: false
	, MoDzYa__GiDri_duk: 0
	, BriYa_GiDri_df: 0.0
	, BriYe_GiDri_df: 0.0

	//@@@
	// NODE
	// MOBILE
	, Hrz3_By__KaGeSpu_y: false

	//@@@
	// SERV
	//@@@
	// CLNs
	// Configs by User
	, TaKeDy_l: {}

	//@@@
	// LOG
	// Sma_vvsg
	, SmaFe_wu: 0
	, Sma_vvsg: new Array( SmaBraHi_wuk ).fill( null )

	//@@@
	// UPD
	, YeFo_wu: 0
	, YeWi_df: 0.0
};
window.Ko = Ko;


//==============================================
// LOGS
// Skipped usual 8 layers for minimal JS
//==============================================
// 'arguments object' is a builtin Array -like object.
// Array.prototype.slice.call(arguments) converts *array-like* 'arguments' to a TRUE array 'ARG_v:
// function SmaSme(){ var ARG_v = Array.prototype.slice.call(arguments); console.log.apply(console, ARG_v); }
SmaJy_vsg = [ 'ðŸ’¬', 'âš ï¸', 'ðŸ¤¯' ];

function SmaTro_vsg( SmaJy_wu, ARG_v )
{
	// PAD '3'
	const Me_vsg = SmaJy_vsg[ SmaJy_wu ] + Ko.SmaFe_wu.toString().padStart( 3, "0" ) + "âž¡ï¸" + ARG_v.join( ' ' );

	// Increment line & wrap as valid entry
	++Ko.SmaFe_wu;
	const SmaFe_wuk = (( Ko.SmaFe_wu ) & SmaViKa_wuk );

	Ko.Sma_vvsg[ SmaFe_wuk ] = Me_vsg;
	return Me_vsg
}

function SmaSme(){ var ARG_v = Array.prototype.slice.call(arguments); console.log( SmaTro_vsg( 0, ARG_v ) );}
function SmaDre(){ var ARG_v = Array.prototype.slice.call(arguments); console.warn( SmaTro_vsg( 1, ARG_v ) );}
function SmaTrx(){ var ARG_v = Array.prototype.slice.call(arguments); console.error( SmaTro_vsg( 2, ARG_v ) );}

//==============================================
// SECURITY
//==============================================

//@@@
// CORS must RUN FIRST
SmaSme( "[LAUNCH] Web_Security[ CORS: " + (window.crossOriginIsolated ?  "âœ…ðŸ˜€" : "âŒðŸ˜ž" ) + " ]" );
if( !window.crossOriginIsolated )
{
	// MSG should display @ DOM
	MoDzTrx( KoSy__KeDru_l.TrxJy00__HrxCheHo__CORS_vsg );
}



//==============================================
// WASM64 preferred
//==============================================
try
{
	// Ko.WASM64_yk = false;
	Ko.WASM64_yk = WebAssembly.validate(new Uint8Array([0,97,115,109,1,0,0,0,5,3,1,4,1]));
}
catch(e)
{
	// WebAssembly is not supported at all
	SmaTrx( 'No Web Assembly: ' + e );
	MoDzTrx( KoSy__KeDru_l.TrxJy01__HrzMoHo__WASM_vsg );
}

Ko.KaBx__TiFo_wuk = navigator.hardwareConcurrency;
SmaSme( "[LAUNCH] Web_Assembly[ " + ( Ko.WASM64_yk ? "64" : "32" ) + "bit:" + ( Ko.WASM64_yk ? "âœ…ðŸ˜€" : "ðŸ†—ðŸ˜") + " ]", "CPUs:", Ko.KaBx__TiFo_wuk );


//==============================================
// DOM
//==============================================

//@@@
// DOM STARTUP
document.addEventListener('readystatechange', function()
{
	// if (document.readyState === 'interactive')
	// {
	// 	SmaSme( "[LAUNCH] WebPage_DOM Interactive" );
	// }

	if (document.readyState === 'complete')
	{
		SmaSme( "[LAUNCH] Web_DOM Fully_Loaded" );


		// Kru__TaNe_v


	}
});

//==============================================
// MODULE INTERFACE
//==============================================
var Module =
{
	// ERR STATUS
	Trx_vsg: null,
	// REQ: Input
	canvas: document.getElementById('MxPo_Bri'),
	// REQ: load
	totalDependencies: 0,

	//@@@
	// EMCC NOTIFY
	// Define how notification messages from Emscripten are displayed via Module.print attribute.
	'print': function ( Sma_vsg ) { SmaSme( "[MSG]" + Sma_vsg ); },
	'printErr': function ( Sma_vsg ) { SmaSme( "[ERR]" + Sma_vsg ); },
	'onAbort': function ( Sma_vsg ) { MoDzTrx( "[ABORT]" + Sma_vsg ); },


	//@@@
	// RUN when WASM_LOADED
	onRuntimeInitialized: function()
	{
        // SmaSme( "WASM module is ready" );
		KoDz__YaFz();
		MoDz__DzStxGru();
    },

	//@@@
	// HEADER BAR
	Sma__KeMe_Bz( Sma_vsg )
	{
		let DzYz__Bz_l = document.getElementById('KeMe_Bz');
		DzYz__Bz_l.innerHTML = "|> "+ ( Sma_vsg );
	},

	//@@@
	// FOOTER BAR
	Sma__KeMe_Bo( Sma_vsg )
	{
		let DzYz__Bo_l = document.getElementById('KeMe_Bo');
		DzYz__Bo_l.innerHTML = "|> " + ( Sma_vsg );
	},

	//@@@
	// LOAD
	monitorRunDependencies( left )
	{
		// NO NEED TO REPORT CURRENTLY
		this.totalDependencies = Math.max(this.totalDependencies, left);
		Module.Sma__KeMe_Bo( left ? ( KoSy__KeDru_l.BriDz_KiMiFe_vsg + ' (' + (this.totalDependencies - left) + '/' + this.totalDependencies + ')') : " " );

	},

};


//==============================================
// ERR
//==============================================

//----------------------------
function MoDzTrx( Trx_vsg )
//----------------------------
{
	//@@@
	// CFG
	// If already 'Err' exit
	if( !Module ) return;
	if( Module.Trx_vsg ) return;
	Module.Trx_vsg = Trx_vsg;

	KoDz__YzChy( BriYz.Trx_qk );

	//@@@
	// ERR MSGBARS

	//&&&
	// HEADER (Fixed)
	// Err Alert, Build Version,
	var Bz_vsg = KoSy__KeDru_l.TrxBz_vsg + " [" + ( window.Ko.Hx_SyDx_vsg ? window.Ko.Hx_SyDx_vsg : "???" ) + " " + BriDzSa__Da_vsg + "] ";
	Module.Sma__KeMe_Bz( Bz_vsg );

	//&&&
	// FOOTER (Dynamic)
	// Please Quit + Err Msg
	var Bo_vsg = KoSy__KeDru_l.TrxKrx_vsg + " " + Trx_vsg;
	Module.Sma__KeMe_Bo( Bo_vsg );


	//&&&
	// DBG
	SmaTrx( Bo_vsg );
	SmaTrx( "*STK_TRACE:", jsStackTrace() );

	// POST for DBG
	// console.error( Bo_vsg );

	// Skip MSGBOX
	// alert( Bo_vsg );

	// DISPLAY ERR
	HryMx01_KeMeTrx();

	// STOP INTERVALS
	// if( window.Ko.Trx_GyHa  ){ clearInterval( window.Ko.Trx_GyHa ); }

	// SERV closes All Else
	KoDz__Yi();
}


//----------------------------
// JS_ERR
window.onerror = (e) =>
//----------------------------
{
	const Trx_vsg = ( JSON.stringify( e ) );
	/*
	// ERR_TYPES
	if (e instanceof TypeError)
	{
		// statements to handle TypeError exceptions
	}
	else if (e instanceof RangeError)
	{
		// statements to handle RangeError exceptions
	}
	else if (e instanceof EvalError)
	{
		// statements to handle EvalError exceptions
	}
	else
	{
		// statements to handle any unspecified exceptions
		//logMyErrors(e); // pass exception object to error handler
	}
	*/

	MoDzTrx( Trx_vsg );
}


//==============================================
// TEST_VALID
//==============================================
function MoDzTrx__NxHo_y( Va, Kri_y )
{
	// SmaSme( "NxHo: ---> " + Va );
	if( !Kri_y )
	{
		MoDzTrx( "ERR: " + Va + " @ " + Kri_y );
		return true;
	}
	return false;
}


//==============================================
// ONE APP only
// PREVENT MULTI_TAB
//==============================================
async function MoDz__DzStxGru()
{
	if( !window.BroadcastChannel )
	{
		SmaSme('!!! Unknown if Duplicate Tab.');
		return;
	}

	// STORE TIME by SESSION
	Ko.MoDzYa__GiDri_duk = (new Date()).getTime();
	sessionStorage.setItem( 'KoGi', Ko.MoDzYa__GiDri_duk );

	// TAB-CONNECTIONS = Broadcast Type
//	var BCHN_l = new BroadcastChannel('tab-connections');
	var BCHN_l = new BroadcastChannel( "MoDz__DzStxGru" );

	//@@@
	//SEND MSG
	// Compare Time
	BCHN_l.postMessage( "MxVy:KoGi" );

	//@@@
	// RECV MSG
	BCHN_l.onmessage = function( e )
	{
		// Split by Colon
		var PKT_k = e.data.split(':');

		if( PKT_k[0] == "KrzVy" )
		{
			// If Newer; Error on Self
			if( Ko.MoDzYa__GiDri_duk > parseInt( PKT_k[1] ))
			{
				SmaSme( "!!! FAIL Duplicate Tab" );
				BCHN_l = null;
				MoDzTrx( KoSy__KeDru_l.TrxJy02__MoDzStxGru_vsg );
			}
			else
			{
				SmaSme( "[LAUNCH] First Tab" );
			}
		}
		else if( PKT_k[0] == "MxVy" )
			{
				// SmaSme('Send Time to Test if Duplicate Tab.');
				BCHN_l.postMessage( "KrzVy:" + Ko.MoDzYa__GiDri_duk );
			}
		}
	}

//=====================================
// IS_MOBILE
//=====================================
function Hrz3_Bz__KaGeSpu_Ha()
{
	// INPUT first of these 3 strings in order found
	const HrzByHx_vsg = ( navigator.userAgent  || navigator.vendor || window.opera );
	// Check REGEX Matches
	if (	/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test( HrzByHx_vsg )
		 ||
		/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test( HrzByHx_vsg.substr( 0, 4 ) )
		)
		{ Ko.Hrz3_By__KaGeSpu_y = true; }
}

//=====================================
// BROWSER VERSION (Browser & App )
//=====================================
async function Hrz3_Bz__VaDa()
{
	//@@@
	// SEARCH

	// USR AGENT
	const HrzByHx_vsg = navigator.userAgent;
	//SmaSme( "[CFG] HrzByHx:", HrzByHx_vsg );

	// /i IGNORE CASE
	// Matches "Name/Ver", "Name", "Ver" for 3 strings in 'match-Array' result
	let Ni_vsg = HrzByHx_vsg.match(/(chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+\.\d+)/i) || [];
	// SmaSme( Ni_vsg );

	// CHILD of CHROME
	let NiNo_vsg = HrzByHx_vsg.match(/(OPR|Edg|OculusBrowser|SamsungBrowser(?=\/))\/?\s*(\d+\.\d+)/i) || [];

	// CLONE name & version#
	if( NiNo_vsg[2] ){ Ni_vsg = NiNo_vsg; }


	// ELSE UNKNOWN
	Ni_vsg = Ni_vsg[2] ? [ Ni_vsg[1], Ni_vsg[2] ] : [ navigator.appName, navigator.appVersion, '-?' ];

	//@@@
	// FORMAT

	// DETECT
	if( (navigator.brave && await navigator.brave.isBrave() || false) ){ Ni_vsg[ 0 ] = "Brave"; }

	// REPLACE
	Ni_vsg[ 0 ] = Ni_vsg[ 0 ].replace( /edg/i, "Edge" );
	Ni_vsg[ 0 ] = Ni_vsg[ 0 ].replace( /opr/i, "Opera" );
	Ni_vsg[ 0 ] = Ni_vsg[ 0 ].replace( /OculusBrowser/i, "Meta" );
	Ni_vsg[ 0 ] = Ni_vsg[ 0 ].replace( /SamsungBrowser/i, "Samsung" );


	// STORE
	Ko.Hrz3_By__Va_vsg = Ni_vsg[ 0 ];
	Ko.Hrz3_By__Da_wfk = parseFloat( Ni_vsg[ 1 ] );
	if( isNaN( Ko.Hrz3_By__Da_wfk ) ){ Ko.Hrz3_By__Da_wfk = 0.0; }

	SmaSme( "[CFG] HrzBy_VaDa", Ko.Hrz3_By__Va_vsg, "||", Ko.Hrz3_By__Da_wfk );
	// NOT WELL SUPPORTED 2026
	// if( navigator.userAgentData && navigator.userAgentData.brands )
	// { SmaSme(  "[CFG] BRAND:", navigator.userAgentData.brands ); }


	//@@@
	// APP VERSION
	document.getElementById( 'BriDzSa__Da' ).innerText = BriDzSa__Da_vsg;

	//@@@
	// SHOW
	const VaDa_v = document.getElementById( 'Hrz3_By__VaDa' );
	VaDa_v.innerText = Ko.Hrz3_By__Va_vsg + " ðŸ“² " + Ko.Hrz3_By__Da_wfk;
}

//==============================================
// END
//==============================================
