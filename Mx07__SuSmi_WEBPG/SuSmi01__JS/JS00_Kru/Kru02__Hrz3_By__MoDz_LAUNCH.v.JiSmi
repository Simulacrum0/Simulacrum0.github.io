//==============================================
// STARTUP
//==============================================

//----------------------------
// SYS_CFG^KoYz
//----------------------------
const BriYz = Object.freeze
({
	HxHo_qk: 0
	, Trx_qk: 1
	, Cho_qk: 2
	, Che_qk: 3

	, Ya_qk: 4
	, Ye_qk: 5
	, Yo_qk: 6
	, Yi_qk: 7
});


//----------------------------
// SYSTEM LOG
//----------------------------
// ONLY SAVE last 64 log lines
const SmaBraHi_wuk = 64;
const SmaViKa_wuk = ( SmaBraHi_wuk - 1 );


//----------------------------
// SYSTEM SERVICE_GOVERNOR
//----------------------------
var Ko =
{
	//@@@
	// BOOT
	WASM64_yk: false
	, MoDzYa__GiDri_duk: 0
	, BriYa_GiDri_df: 0.0
	, BriYe_GiDri_df: 0.0

	, Trx_vsg: null

	//@@@
	// NODE
	// MOBILE
	, Hrz3_By__KaGeSpu_y: false
	, Hrz3_By__VaDe_vsg: "Unknown OS"
	, Hrz3_By__Gwz_vsg: "GLOBAL"

	, Hrz4_Bu__VaDe_vsg: "Unknown Browser"

	// CPU
	, KaBz__Gwz_vsg: "CHECK"
	, KaBz__VaDe_vsg: "unknown"
	// GPU
	, KaBx__Gwz_vsg: "CHECK"
	, KaBx__VaDe_vsg: "unknown"
	// NPU
	, KaBa__Gwz_vsg: "DISABLE"
	, KaBa__VaDe_vsg: "none"


	//@@@
	// SERV
	//@@@
	// CLNs
	// Configs by User
	, TaKeDy_l: {}

	//@@@
	// LOG
	// Sma_vvsg
	, SmaFe_wu: 0
	, Sma_vvsg: [ SmaBraHi_wuk ].fill( null )

	//@@@
	// UPD
	, YeFo_wu: 0
	, YeWi_df: 0.0
};
Ko = Ko;


//==============================================
// LOGS
// Skipped usual 8 layers for minimal JS
//==============================================
// 'arguments object' is a builtin Array -like object.
// Array.prototype.slice.call(arguments) converts *array-like* 'arguments' to a TRUE array 'ARG_v:
// function LOG(){ var ARG_v = Array.prototype.slice.call(arguments); console.log.apply(console, ARG_v); }

//----------------------------------
const SmaJy_vsg =
//----------------------------------
[
	// LOG ICONS:
	// Sy, Je, Dre, Trx
	'ðŸ¤–', 'âœ…', 'ðŸ˜•','ðŸ¤¯'
	// 'âš™ï¸', 'â„¹ï¸', 'âš ï¸', 'ðŸš«'
];

//----------------------------------
function SmaTro_vsg( SmaJy_wu, ARG_v )
//----------------------------------
{
	//@@@
	// FILTER by TAG before collapsing ARG into String?
	// if( ARG_v[0] === "[CFG]" ) return;

	//@@@
	// PAD '3' digits
	const Me_vsg = SmaJy_vsg[ SmaJy_wu ] + Ko.SmaFe_wu.toString().padStart( 3, "0" ) + " âž¡ï¸ " + ARG_v.join( ' ' );

	// Increment line & wrap as valid entry
	const SmaFe_wuk = (( Ko.SmaFe_wu ) & SmaViKa_wuk );
	++Ko.SmaFe_wu;

	Ko.Sma_vvsg[ SmaFe_wuk ] = Me_vsg;
	return Me_vsg
}

//----------------------------------
// LOG by AUDIENCE
//----------------------------------
function SmaSy(){ var ARG_v = Array.prototype.slice.call(arguments); console.log( SmaTro_vsg( 0, ARG_v ) );}
function SmaJe(){ var ARG_v = Array.prototype.slice.call(arguments); console.log( SmaTro_vsg( 1, ARG_v ) );}
function SmaDre(){ var ARG_v = Array.prototype.slice.call(arguments); console.warn( SmaTro_vsg( 2, ARG_v ) );}
function SmaTrx(){ var ARG_v = Array.prototype.slice.call(arguments); console.error( SmaTro_vsg( 3, ARG_v ) );}

function SmaGwxHu(){ SmaJe( "[" + this.VaDy_vsg + "]----------------------------------" ); }
function SmaGwxDe(){ SmaJe( "[" + this.VaDy_vsg + "]=============================" ); }
function SmaGwxHi(){ SmaJe( "[" + this.VaDy_vsg + "]################################" ); }

//----------------------------------
// OBJ CONSOLE
function SmaDBG()
//----------------------------------
{
	var ARG_v = Array.prototype.slice.call(arguments);
	console.log.apply(console, ARG_v);
}

//----------------------------------
// OBJ LOG
function SmaKzFu( Kz_k )
//----------------------------------
{
	Object.keys( Kz_k ).forEach( _Va => { SmaDBG( _Va ); });
	Object.values( Kz_k ).forEach( _Vu => { SmaDBG( _Vu ); });
}



//----------------------------
// JS_ERR
window.onerror = (e) =>
//----------------------------
{
	const Trx_vsg = ( JSON.stringify( e ) );

	// LOG ERR
	SmaDBG( e );

	// ERR_TYPES
	/*
	if(e instanceof TypeError)
	{
		// statements to handle TypeError exceptions
	}
	else if(e instanceof RangeError)
	{
		// statements to handle RangeError exceptions
	}
	else if(e instanceof EvalError)
	{
		// statements to handle EvalError exceptions
	}
	else
	{
		// statements to handle any unspecified exceptions
	}
	*/

	MoDzTrx( Trx_vsg );
}

//==============================================
// BOOTUP
//
// !!!
// NOTE: Errors must be saved to show later
// !!!
//
//==============================================
function MoDz__BOOT()
{
	//----------------------------------
	// SECURITY
	//----------------------------------

	//@@@
	// CORS must RUN FIRST
	SmaSy( "[LAUNCH] Web_Security via CORS: " + (window.crossOriginIsolated ?  "âœ…ðŸ˜€" : "âŒðŸ˜ž" ) );
	if( !window.crossOriginIsolated )
	{
		// MSG should display @ DOM
		// SmaTrx( "[LAUNCH] No CORS Security" );
		Ko.Trx_vsg = ( KoSy__KwiGru_KeDru_l.TrxJy00__HrxCheHo__CORS_vsg );
	}

	//----------------------------------
	// WASM64 preferred
	//----------------------------------
	try
	{
		//$$$
		// TEST PURPOSES?
		// Ko.WASM64_yk = false;
		Ko.WASM64_yk = WebAssembly.validate(new Uint8Array([0,97,115,109,1,0,0,0,5,3,1,4,1]));
	}
	catch(e)
	{
		// WebAssembly is not supported at all
		// SmaTrx( "[LAUNCH] No Web Assembly:", e );
		Ko.Trx_vsg = ( KoSy__KwiGru_KeDru_l.TrxJy01__HrzMoHo__WASM_vsg );
	}

	Ko.KaBx__TiFo_wuk = navigator.hardwareConcurrency;
	SmaSy( "[LAUNCH] Web_Assembly: " + ( Ko.WASM64_yk ? "64" : "32" ) + "bit:" + ( Ko.WASM64_yk ? "âœ…ðŸ˜€" : "ðŸ†—ðŸ˜") + " CPUs:", Ko.KaBx__TiFo_wuk );

	//----------------------------------
	// DOM STARTUP
	//----------------------------------
	document.addEventListener( 'readystatechange', function()
	{
		// if(document.readyState === 'interactive')
		// {
		// 	SmaSy( "[LAUNCH] WebPage_DOM Interactive" );
		// }

		if(document.readyState === 'complete')
		{
			SmaSy( "[LAUNCH] Web_DOM Fully_Loaded" );
		}
	});

	//----------------------------------
	// RESIZE
	//----------------------------------
	window.addEventListener( "resize", KoDz_GyHa );
}

//!!!
// RUN FIRST
MoDz__BOOT();


//==============================================
// MODULE INTERFACE for EMSCRIPTEN ENGINE
//==============================================
var Module =
{
	// ERR STATUS
	Trx_vsg: null,
	// REQ: Input
	canvas: document.getElementById('MxPo_Bri'),
	// REQ: load
	totalDependencies: 0,

	//@@@
	// EMCC NOTIFY
	// Define how notification messages from Emscripten are displayed via Module.print attribute.
	'print': function ( Sma_vsg ) { SmaJe( "[MSG]" + Sma_vsg ); },
	'printErr': function ( Sma_vsg ) { SmaTrx( "[ERR]" + Sma_vsg ); },
	'onAbort': function ( Sma_vsg ) { MoDzTrx( "[ABORT]" + Sma_vsg ); },


	//@@@
	// RUN when WASM_LOADED
	onRuntimeInitialized: function()
	{
        // SmaSy( "WASM module is ready" );
		if( Ko.Trx_vsg )
		{
			// IF WE FAILED ABOVE, we have to wait until we get here
			//  to SHOW ERR screen, so we must save and 'clear' the existing error
			// so it won't be ignored.
			const Trx_vsg = Ko.Trx_vsg;
			Ko.Trx_vsg = null;
			MoDzTrx( Trx_vsg );
			return;
		}
		KoDz__YaFz();
		MoDz__DzStxGru();
    },

	//@@@
	// HEADER BAR
	Sma__KeMe_Bz( Sma_vsg )
	{
		let DzYz__Bz_l = document.getElementById('KeMe_Bz');
		DzYz__Bz_l.innerHTML = "|> "+ ( Sma_vsg );
	},

	//@@@
	// FOOTER BAR
	Sma__KeMe_Bo( Sma_vsg )
	{
		let DzYz__Bo_l = document.getElementById('KeMe_Bo');
		DzYz__Bo_l.innerHTML = "|> " + ( Sma_vsg );
	},

	//@@@
	// LOAD
	monitorRunDependencies( left )
	{
		// NO NEED TO REPORT CURRENTLY
		this.totalDependencies = Math.max(this.totalDependencies, left);
		Module.Sma__KeMe_Bo( left ? ( KoSy__KwiGru_KeDru_l.BriDz_KiMiFe_vsg + ' (' + (this.totalDependencies - left) + '/' + this.totalDependencies + ')') : " " );

	},

};


//==============================================
// ERR
//==============================================

//----------------------------
function MoDzTrx( Trx_vsg )
//----------------------------
{
	//@@@
	// CFG
	// If already 'Err' exit
	if( Ko.Trx_vsg ) return;

	Ko.Trx_vsg = Trx_vsg;
	KoDz__YzChy( BriYz.Trx_qk );


	//@@@
	// ERR MSGBARS

	//&&&
	// HEADER (Fixed)
	// Err Alert, Build Version,
	const Bz_vsg = KoSy__KwiGru_KeDru_l.TrxBz_vsg + " [" + ( Ko.Hx_SyDx_vsg ? Ko.Hx_SyDx_vsg : "???" ) + " " + BriDzSa__Da_vsg + "] ";

	//&&&
	// FOOTER (Dynamic)
	// Please Quit + Err Msg
	const Bo_vsg = KoSy__KwiGru_KeDru_l.TrxKrx_vsg + " " + Trx_vsg;

	//&&&
	// GUI MSGBARS
	Module.Sma__KeMe_Bz( Bz_vsg );
	Module.Sma__KeMe_Bo( Bo_vsg );

	//&&&
	// DBG
	SmaTrx( "[FAIL]", Bo_vsg );
	SmaTrx( "[FAIL] *STK_TRACE*:", jsStackTrace() );

	// POST for DBG
	// console.error( Bo_vsg );

	// Skip MSGBOX
	// alert( Bo_vsg );

	// DISPLAY ERR
	HryMx01_KeMeTrx();

	//$$$
	// REFRESH @ INTERVALS
	// Unneeded
	// Ko.Trx_GyHa = setInterval( KoDz_GyHa, 2000 );
	// if( Ko.Trx_GyHa  ){ clearInterval( Ko.Trx_GyHa ); }

	// SERV closes All Else
	KoDz__Yi();
}


//==============================================
// TEST_VALID
//==============================================
function MoDzTrx__NxHo_y( Va, Kri_y )
{
	// SmaSy( "NxHo: ---> " + Va );
	if( !Kri_y )
	{
		MoDzTrx( "[FAIL]: " + Va + " @ " + Kri_y );
		return true;
	}
	return false;
}


//==============================================
// ONE APP only
// PREVENT MULTI_TAB
//==============================================
async function MoDz__DzStxGru()
{
	if( !window.BroadcastChannel )
	{
		SmaJe( "[LAUNCH] !!! Unknown if Duplicate Tab." );
		return;
	}

	// STORE TIME by SESSION
	Ko.MoDzYa__GiDri_duk = (new Date()).getTime();
	sessionStorage.setItem( 'KoGi', Ko.MoDzYa__GiDri_duk );

	// TAB-CONNECTIONS = Broadcast Type
//	var BCHN_l = new BroadcastChannel('tab-connections');
	var BCHN_l = new BroadcastChannel( "MoDz__DzStxGru" );

	//@@@
	//SEND MSG
	// Compare Time
	BCHN_l.postMessage( "MxVy:KoGi" );

	//@@@
	// RECV MSG
	BCHN_l.onmessage = function( e )
	{
		// Split by Colon
		var PKT_k = e.data.split(':');

		if( PKT_k[0] == "KrzVy" )
		{
			// If Newer; Error on Self
			if( Ko.MoDzYa__GiDri_duk > parseInt( PKT_k[1] ))
			{
				SmaTrx( "[LAUNCH] !!! FAIL Duplicate Tab" );
				BCHN_l = null;
				MoDzTrx( KoSy__KwiGru_KeDru_l.TrxJy02__MoDzStxGru_vsg );
			}
			else
			{
				SmaTrx( "[LAUNCH] First Tab" );
			}
		}
		else if( PKT_k[0] == "MxVy" )
			{
				// SmaSy('Send Time to Test if Duplicate Tab.');
				BCHN_l.postMessage( "KrzVy:" + Ko.MoDzYa__GiDri_duk );
			}
		}
	}

//=====================================
// NODE & CPU
//=====================================
function Hrz3_By__FyTo()
{
	const NODE_vksg = navigator.userAgent.toUpperCase();

	SmaSy( "[LAUNCH] Node:", NODE_vksg );

	//@@@
	// BACKUP
	if( navigator.userAgentData )
	{
		Ko.Hrz3_By__VaDe_vsg = navigator.userAgentData.platform;
		//MOBILE = navigator.userAgentData.mobile;
		//
		// FAIL on Ko.KaBz__VaDe_vsg as it doesn't match below
		// navigator.userAgentData.getHighEntropyValues( ["architecture", "platformVersion"])
		// .then( ua =>
		// {
		// 	// Ko.KaBz__VaDe_vsg = ua.architecture;
		// 	// VER = ua.platformVersion;
		// } );
	}

	//@@@
	// MOST ANDROID shows LINUX in platform
	if( NODE_vksg.includes( "ANDROID" ) )
	{
		Ko.Hrz3_By__Gwz_vsg = "DRD";
		Ko.Hrz3_By__VaDe_vsg = "Android";

		Ko.Hrz3_By__KaGeSpu_y = true;
	}
	else if( NODE_vksg.includes( "LINUX" ) || NODE_vksg.includes( "X11" ) || NODE_vksg.includes( "WAYLAND" ) )
	{
		Ko.Hrz3_By__Gwz_vsg = "LNX";
		Ko.Hrz3_By__VaDe_vsg = "Linux";
	}
	else if( NODE_vksg.includes( "IPAD" ) )
	{
		Ko.Hrz3_By__Gwz_vsg = "IOS";
		Ko.Hrz3_By__VaDe_vsg = "iPadOS";

		Ko.KaBz__Gwz_vsg = "ARM";
		Ko.KaBz__VaDe_vsg = "ARM64";

		Ko.Hrz3_By__KaGeSpu_y = true;
	}
	else if( NODE_vksg.includes( "IPHONE" ) )
	{
		Ko.Hrz3_By__Gwz_vsg = "IOS";
		Ko.Hrz3_By__VaDe_vsg = "iOS";

		Ko.KaBz__Gwz_vsg = "ARM";
		Ko.KaBz__VaDe_vsg = "ARM64";

		Ko.Hrz3_By__KaGeSpu_y = true;
	}
	else if( NODE_vksg.includes( "MAC" ) )
	{
		Ko.Hrz3_By__Gwz_vsg = "MAC";
		Ko.Hrz3_By__VaDe_vsg = "Mac";

		Ko.KaBz__Gwz_vsg = "ARM";
		Ko.KaBz__VaDe_vsg = "ARM64";
	}
	else if( NODE_vksg.includes( "WINDOWS" ) )
	{
		Ko.Hrz3_By__Gwz_vsg = "WIN";
		Ko.Hrz3_By__VaDe_vsg = "Windows";
	}


	//@@@
	// CPU
	if( NODE_vksg.includes( "X86_64" ) || NODE_vksg.includes( "X64" ) )
	{
		Ko.KaBz__Gwz_vsg = "INTEL";
		Ko.KaBz__VaDe_vsg = "X64";
	}
	else if( NODE_vksg.includes( "ARM" ) || NODE_vksg.includes( "AARCH" ) )
	{
		Ko.KaBz__Gwz_vsg = "ARM";
		Ko.KaBz__VaDe_vsg = "ARM64";
	}
	else if( NODE_vksg.includes( "RISCV" ) || NODE_vksg.includes( "RISC-V" ) )
	{
		Ko.KaBz__Gwz_vsg = "RISCV";
		Ko.KaBz__VaDe_vsg = "RISC-V";
	}

}

//=====================================
// BROWSER VERSION (Browser & App )
//=====================================
async function Hrz4_Bu__FyTo()
{
	//@@@
	// SEARCH

	// USR AGENT
	const HrzByHx_vsg = navigator.userAgent;
	//SmaSy( "[CFG] HrzByHx:", HrzByHx_vsg );

	// /i IGNORE CASE
	// Matches "Name/Ver", "Name", "Ver" for 3 strings in 'match-Array' result
	let Ni_vsg = HrzByHx_vsg.match(/(chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+\.\d+)/i) || [];
	// SmaSy( Ni_vsg );

	// CHILD of CHROME
	let NiNo_vsg = HrzByHx_vsg.match(/(OPR|Edg|OculusBrowser|SamsungBrowser(?=\/))\/?\s*(\d+\.\d+)/i) || [];

	// CLONE name & version#
	if( NiNo_vsg[2] ){ Ni_vsg = NiNo_vsg; }


	// ELSE UNKNOWN
	Ni_vsg = Ni_vsg[2] ? [ Ni_vsg[1], Ni_vsg[2] ] : [ navigator.appName, navigator.appVersion, '-?' ];

	//@@@
	// FORMAT

	// DETECT
	if( (navigator.brave && await navigator.brave.isBrave() || false) ){ Ni_vsg[ 0 ] = "Brave"; }

	// REPLACE
	Ni_vsg[ 0 ] = Ni_vsg[ 0 ].replace( /edg/i, "Edge" );
	Ni_vsg[ 0 ] = Ni_vsg[ 0 ].replace( /opr/i, "Opera" );
	Ni_vsg[ 0 ] = Ni_vsg[ 0 ].replace( /OculusBrowser/i, "Meta" );
	Ni_vsg[ 0 ] = Ni_vsg[ 0 ].replace( /SamsungBrowser/i, "Samsung" );


	// STORE
	Ko.Hrz4_Bu__VaDe_vsg = Ni_vsg[ 0 ];
	Ko.Hrz4_Bu__Da_wfk = parseFloat( Ni_vsg[ 1 ] );
	if( isNaN( Ko.Hrz4_Bu__Da_wfk ) ){ Ko.Hrz4_Bu__Da_wfk = 0.0; }

	SmaJe( "[LAUNCH] HrzBy_VaDa", Ko.Hrz4_Bu__VaDe_vsg, "||", Ko.Hrz4_Bu__Da_wfk );
	// NOT WELL SUPPORTED 2026
	// if( navigator.userAgentData && navigator.userAgentData.brands )
	// { SmaJe(  "[LAUNCH] BRAND:", navigator.userAgentData.brands ); }
}

//==============================================
// END
//==============================================
